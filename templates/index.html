{% extends "default_base.html" %}
{% block body %}
<div class="container">
  <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
    <div class="panel panel-default">
      <div class="panel-heading" role="tab" id="headingOne">
        <h4 class="panel-title">
          <a role="button" id="filter_accordion" data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
            Filter Function Classes
          </a>
        </h4>
      </div>
      <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
        <div class="panel-body">

          <form action="" method="post" id='filter_form' name="filter" class="filter_function">

            <h4>General Settings</h4>
            <div class="row">
              <div class="col-md-3">
                  {{ form.hidden_tag() }}
                <div class="form-group">
                  <label for="function_class">Function Class</label>
                  {{ form.function_class(class="form-control") }}
                  <label for="limit">Number of rows</label>
                  {{ form.limit(class="form-control") }}
                </div>
              </div>

              <div class="col-md-3 col-md-offset-1">
                <div id="filter_alternative_radio">
                  {% for subfield in form.filter_alternative %}
                  <div class="radio">
                    <label>
                      {{ subfield }}
                      {{ subfield.label.text}}
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>
              <div class="col-md-5">
                <fieldset class="filter_with_search">
                  <label for={{ "filter_with_search" }}>Start searching by typing here</label>
                  {{ form.search_annotations(class="form-control") }}
                </fieldset>
                <fieldset class="filter_with_type_identifiers">
                  <div class="form-group" id="type_identifiers">
                    <ul class="list-unstyled">
                      {% for subfield in form.type_identifiers.entries %}
                        <li>
                        <label for={{ subfield.id }}>Type Identifier</label>
                        {{ subfield(class="form-control") }}
                        </li>
                      {% endfor %}
                    </ul>
                    <button class="btn btn-default" type="button" id="AddAnotherTypeIdentifier">Add another type identifier</button>
                    <button class="btn btn-default" type="button" id="RemoveLastTypeIdentifier">Remove last type identifier</button>
                  </div>
                </fieldset>
              </div>
              <div class="col-md-11">
                <div id="search_result_annotations">
                </div>
              </div>
              <div class="col-md-1">
              </div>
            </div>

            <button type="submit" id="submit_filter" class="btn btn-default">Filter</button>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>



{% include 'function_classes_table.html' %}

<script type=text/javascript>
  $(document).ready(function () {
      $('#AddAnotherTypeIdentifier').click(function () {
          clone_field_list('.form-group#type_identifiers li:last');
      });

      $('#RemoveLastTypeIdentifier').click(function () {
          remove_last_field_list('.form-group#type_identifiers li:last');
      });

      $('#filter_alternative_radio .radio label input').click(function(event) {
        selector_to_disable = $("fieldset:not([disabled])")
        selector_to_enable = $("fieldset.".concat($(this).val()));
        disable_form_element(selector_to_disable, selector_to_enable);
      });

      fetch_search_result();

      selector_to_disable = $("fieldset:not([disabled])")
      selector_to_enable = $("fieldset.".concat($("#filter_alternative_radio :checked").val()));
      disable_form_element(selector_to_disable, selector_to_enable);
      enable_tooltip();
      hide_description_column();
      $('#toggle_description_column').click(function(event) {
        if ($(this).attr('value') == 'show') {
           $(this).text("Hide description");
           $(this).attr('value', 'hide');
           show_description_column();
        } else {
           $(this).text("Show description");
           $(this).attr('value', 'show');
           hide_description_column();
        }
      });
  });

  function enable_tooltip() {
    $('[data-toggle="tooltip"]').tooltip();
  }

  function show_description_column(){
    $('#function_classes_table thead .annotation_description').show();
    $('#function_classes_table tbody .annotation_description').show();
  }

  function hide_description_column(){
    $('#function_classes_table thead .annotation_description').hide();
    $('#function_classes_table tbody .annotation_description').hide();
  }

  function clone_field_list(selector) {
      var new_element = $(selector).clone(true);

      /* Increment id integer with 1 */
      var elem_id = new_element.find(':input')[0].id;
      var elem_num = parseInt(elem_id.replace(/.*-([0-9]+).*/m, '$1')) + 1;

      /* Update all input and label tags within the new element */
      new_element.find(':input').each(function() {
          var id = $(this).attr('id').replace('-' + (elem_num - 1), '-' + elem_num);
          $(this).attr({'name': id, 'id': id}).val('').removeAttr('checked');
      });
      new_element.find('label').each(function() {
          var new_for = $(this).attr('for').replace('-' + (elem_num - 1), '-' + elem_num);
          $(this).attr('for', new_for);
      });
      $(selector).after(new_element);
  }

  function remove_last_field_list(selector) {
      var elem_id = $(selector).find(':input')[0].id;
      var elem_num = parseInt(elem_id.replace(/.*-([0-9]+).*/m, '$1'));

      if (elem_num > 0) {
        $(selector).remove();
      }
  }

  $('#search_annotations').on('input', function(e){
    fetch_search_result()
  });

  function fetch_search_result() {
    var current_input = $('#search_annotations').val();
    $.get( "ajax/search_annotations", { text_input: current_input }, function(data){
      $('#search_result_annotations').replaceWith(data);
    });
  };


  function disable_form_element(selector_to_disable, selector_to_enable) {
    selector_to_disable.prop('disabled', true);
    selector_to_enable.prop('disabled', false);
  }

</script>
{% endblock body %}
